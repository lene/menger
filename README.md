# Menger - A Scala implementation of the Menger sponge in three and higher dimensions

A [Menger Sponge](https://en.wikipedia.org/wiki/Menger_sponge) is a fractal generated by subdividing
a cube into 27 smaller cubes of a third of the side length and removing the center cube and the 
cubes that share a face with it, leaving a hole in the center of each cube face. For each step of 
the generation of the fractal, this process is repeated for each of the remaining cubes, in theory 
repeating ad infinitum, but in practice it is stopped after a small number of steps due to 
processing time and memory constraints. 

The Menger Sponge is a 3D analog of the one-dimensional 
[Cantor Set](https://en.wikipedia.org/wiki/Cantor_set) and the two-dimensional 
[Sierpinski Carpet](https://en.wikipedia.org/wiki/Sierpinski_carpet). Its 
[Hausdorff dimension](https://en.wikipedia.org/wiki/Hausdorff_dimension) is 
$\log_3 20 = \frac{\log{20}}{\log{3}} \approx 2.727$.

## Alternative generation process

Instead of replacing a cube with 20 smaller cubes at every step of the generation process, the same
result can be achieved by subdividing each square face into 9 smaller squares, removing the center 
square and adding 4 squares that define the hole punched by removing the cube in the middle of the 
face. This process results in 12 smaller squares, arranged around the hole in the face. Repeating 
this process for every step of the generation process leads to the Menger Sponge fractal.

In contrast to generating a Menger Sponge from cubes, this version of the sponge has no internal 
surfaces, only the outer surface of the sponge. This process results in a computational complexity 
of $O(12^n)$ for the number of squares generated at each step, as opposed to $O(20^n)$ for the cube 
subdivision process.

## Higher-dimensional analogs

The four dimensional analog of a cube, the [Tesseract](https://en.wikipedia.org/wiki/Tesseract), can 
be treated the same way as the cube to generate the four dimensional Menger Sponge analog. The 
Tesseract is subdivided into 81 smaller Tesseracts, leaving out all Tesseracts that border on the 
center of a face of the original Tesseract for a total of 48 remaining Tesseracts.

The 4D sponge's Hausdorff dimension is $\log_3 48 = \frac{\log{48}}{\log{3}} \approx 3.524$.

It is equally possible to generate a four-dimensional Menger Sponge analog by subdividing each face
and replacing the center square with the faces of the hole in the center of the face, leading to 16
squares for each original square face. This process results in a computational complexity of
$O(16^n)$ instead of $O(48^n)$ for the Tesseract subdivision process.

## Fractional levels

All sponge types support fractional levels (e.g., `--level 1.5`), which renders two overlapping
sponges with smooth alpha blending: the floor level (e.g., level 1) rendered transparently, and the
ceiling level (e.g., level 2) rendered opaque. The transparency of the lower level increases 
linearly from fully opaque at integer levels to fully transparent as it approaches the next integer 
level.


# Build Requirements

## Quick Start

For most users, the pre-built Docker image is the easiest way to get started. See [CI/CD documentation](docs/CI_CD.md) for Docker setup.

For a complete installation from scratch (CUDA, OptiX, Java, sbt), see the **[Installation from Scratch Guide](docs/INSTALLATION_FROM_SCRATCH.md)**.

## CMake

The project requires CMake 3.x for building the OptiX JNI bindings.

**Note:** The project includes a `cmake` wrapper script that filters out a harmless warning caused
by an sbt-jni version parsing bug. To use it, create a symlink in your local bin directory:

```bash
mkdir -p ~/.local/bin
ln -sf "$PWD/cmake" ~/.local/bin/cmake
```

This only needs to be done once. The wrapper ensures `~/.local/bin/cmake` is found before the system
cmake, filtering out the annoying "Ignoring extra path from command line" warning.

## CUDA and OptiX

For GPU acceleration features (optional), you need:
- CUDA Toolkit 12.0 or later
- NVIDIA OptiX SDK 9.0+

**Installation guides:**
- [Installation from Scratch](docs/INSTALLATION_FROM_SCRATCH.md) - Complete step-by-step guide
- [GPU Development Setup](docs/GPU_DEVELOPMENT.md) - AWS EC2 GPU instance setup

# Usage

Compile code with `sbt compile`, test with `sbt test`, run with `sbt run`, and `sbt console`
for a Scala 3 REPL.

## Options
- `--timeout <float>` - Exit after specified seconds (useful for testing)
- `--sponge-type <type>` - Type of sponge to render:
  - `square` - 2D square
  - `cube` - 3D cube
  - `square-sponge` - Menger sponge by surface subdivision
  - `cube-sponge` - Menger sponge by volume subdivision
  - `tesseract` - 4D tesseract
  - `tesseract-sponge` - 4D sponge (48 tesseracts)
  - `tesseract-sponge-2` - 4D sponge (16 faces per face)
  - `composite[type1,type2,...]` - Overlay multiple geometries
- `--level <float>` - Fractal iteration level (supports fractional values)
- `--lines` - Render as wireframe
- `--color <rrggbb[aa]>` - Hex color code (e.g., ff0000 for red). Cannot be used with `--face-color`
  or `--line-color`.
- `--face-color <rrggbb[aa]>` - Color for filled faces in overlay mode (supports RGBA for 
  transparency)
- `--line-color <rrggbb[aa]>` - Color for wireframe lines in overlay mode (supports RGBA for 
  transparency)
  - **Overlay mode**: When both `--face-color` and `--line-color` are specified, renders transparent
    faces with wireframe overlay
  - Example: `--face-color ffffff40 --line-color 000000ff` (transparent white faces with opaque 
    black lines)
  - Note: Both must be specified together. Cannot be used with `--color` or `--lines`.
- `--projection-screen-w <float>` - 4D projection screen distance
- `--projection-eye-w <float>` - 4D projection eye distance
- `--rot-x-w <float>` - 4D rotation around XW plane
- `--rot-y-w <float>` - 4D rotation around YW plane
- `--rot-z-w <float>` - 4D rotation around ZW plane
- `--width <int>` - Window width
- `--height <int>` - Window height
- `--antialias-samples <int>` - MSAA samples
- `--animate <spec>` - Animation specification supporting:
  - Rotation: `rot-x`, `rot-y`, `rot-z` (3D rotation angles)
  - 4D rotation: `rot-x-w`, `rot-y-w`, `rot-z-w` (4D rotation angles)
  - 4D projection: `projection-screen-w`, `projection-eye-w` (4D camera settings)
  - Level animation: `level` (fractal iteration level for sponge types)
  - Examples:
    - `frames=10:rot-y=0-360` - Rotate 360Â° around Y axis over 10 frames
    - `frames=20:level=0-3` - Animate from level 0 to 3 over 20 frames
    - `frames=10:level=0-2:rot-y=0-90` - Combine level and rotation animation
  - Chaining: Multiple animation specifications can be chained using `--animate` multiple times
    - `--animate frames=10:rot-x-w=0-10 --animate frames=10:rot-y-w=0-10` - Sequential rotations
    - `--animate frames=10:level=0-2 --animate frames=10:level=2-0` - Animate level up then down
  - Note: Parameters cannot be specified both as CLI options (e.g., `--level`, `--rot-x`) and in
    animation specifications
- `--save-name <pattern>` - Save frames to files (e.g., `frame%d.png`)

### OptiX Ray Tracing Options

For GPU-accelerated ray tracing using NVIDIA OptiX (requires `--sponge-type sphere` and `--optix`):

- `--optix` - Enable OptiX renderer (requires `--sponge-type sphere`)
- `--radius <float>` - Sphere radius (default: 1.0)
- `--ior <float>` - Index of refraction for glass rendering (default: 1.5)
  - 1.0 = no refraction, 1.33 = water, 1.5 = glass, 2.42 = diamond
- `--scale <float>` - Scale parameter (default: 1.0)
- `--stats` - Display ray tracing statistics after render
- `--shadows` - Enable shadow rays for realistic shadows (requires `--optix`)
- `--light <spec>` - Add light source (repeatable, max 8)
  - Format: `<type>:x,y,z[:intensity[:color]]`
  - Types: `directional` (parallel rays, sun-like) or `point` (radiates from position)
  - Intensity: brightness multiplier (default: 1.0)
  - Color: hex (e.g., `ffffff`) or RGB (e.g., `255,0,0`)
  - Examples:
    - `--light directional:-1,1,-1` - Directional light from upper-left-back
    - `--light point:0,5,0:2.0:ffffff` - Bright white point light above sphere
    - `--light directional:0,1,0::ff0000` - Red directional light (omit intensity with ::)
- `--camera-pos <x,y,z>` - Camera position (default: 0,0.5,3)
- `--camera-lookat <x,y,z>` - Camera look-at point (default: 0,0,0)
- `--camera-up <x,y,z>` - Camera up vector (default: 0,1,0)
- `--center <x,y,z>` - Sphere center position (default: 0,0,0)
- `--plane <spec>` - Ground plane specification (default: +y:-2)
  - Format: `[+-]?[xyz]:<value>` (e.g., `y:-2`, `+y:-2`, `-z:5.5`)

Example OptiX usage:
```bash
# Basic glass sphere
sbt "run --optix --sponge-type sphere --radius 1.5 --ior 1.5"

# Glass sphere with shadows and custom lighting
sbt "run --optix --sponge-type sphere --shadows \
  --light directional:-1,1,-1:1.5 \
  --light point:2,3,2:0.8:ffd700"

# Display ray statistics
sbt "run --optix --sponge-type sphere --stats"
```

## Remote GPU Development

For CUDA/OptiX development on AWS EC2 GPU instances with automated provisioning, state
management, and cost controls, see [GPU_DEVELOPMENT.md](GPU_DEVELOPMENT.md) for the complete
guide.

[![Ask DeepWiki](https://deepwiki.com/badge.svg)](https://deepwiki.com/lene/menger)
