# Terraform Configuration Structure

Terraform infrastructure-as-code for AWS EC2 spot instances with NVIDIA GPUs.

**For usage instructions, see [GPU_DEVELOPMENT.md](../GPU_DEVELOPMENT.md).**

## File Structure

```
terraform/
├── README.md              # This file
├── versions.tf            # Terraform and provider versions
├── variables.tf           # Input variables
├── main.tf                # EC2 spot instance, security group, key pair
├── outputs.tf             # Instance IP, SSH command
├── user-data.sh           # Instance initialization script
├── ami-build.pkr.hcl      # Packer template (alternative to build-ami.sh)
└── terraform.tfvars       # Generated by nvidia-spot.sh

scripts/
├── nvidia-spot.sh         # Main CLI wrapper
├── build-ami.sh           # AMI builder
├── list-instances.sh      # Query available instances and prices
├── auto-terminate.sh      # Daemon for logout detection
├── backup-spot-state.sh   # Save instance state to local storage
├── restore-spot-state.sh  # Restore previously saved state
├── list-spot-states.sh    # List available saved states
└── cleanup-spot-states.sh # Clean up old saved states
```

## Terraform Variables

```hcl
region           = "us-east-1"
instance_type    = "g4dn.xlarge"
max_spot_price   = "0.50"
max_session_cost = 10.00
ami_id           = "ami-xxxxxxxxxxxx"
user_public_key  = "ssh-rsa AAAA..."
auto_terminate   = true
availability_zone = ""  # Optional, defaults to cheapest AZ
```

## Manual Terraform Usage

```bash
cd terraform

# Initialize
terraform init

# Create terraform.tfvars
cat > terraform.tfvars <<EOF
region           = "us-east-1"
instance_type    = "g4dn.xlarge"
max_spot_price   = "0.50"
max_session_cost = 10.00
ami_id           = "ami-xxxxxxxxxxxx"
user_public_key  = "$(cat ~/.ssh/id_rsa.pub)"
auto_terminate   = true
EOF

# Plan and apply
terraform plan
terraform apply

# Get outputs
terraform output instance_public_ip
terraform output ssh_command

# Destroy when done
terraform destroy
```
